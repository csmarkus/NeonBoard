<div class="px-3 py-3 border-t border-subtle relative">
  <button
    (click)="toggleMenu.emit()"
    [class]="buttonClasses()"
    [attr.aria-label]="collapsed() ? 'User menu' : null"
    [attr.aria-haspopup]="'menu'"
    [attr.aria-expanded]="menuOpen()"
  >
    @if (user().picture) {
      <img
        [src]="user().picture"
        [alt]="user().name || 'User'"
        class="w-8 h-8 rounded-full object-cover shrink-0"
      />
    } @else {
      <div class="w-8 h-8 rounded-full bg-accent/20 flex items-center justify-center shrink-0">
        <span class="text-sm text-accent font-medium">{{ getUserInitials(user().name) }}</span>
      </div>
    }
    @if (!collapsed()) {
      <div class="flex-1 min-w-0 text-left">
        <div class="text-sm text-primary truncate">{{ user().name }}</div>
        <div class="text-xs text-muted truncate">{{ user().email }}</div>
      </div>
      <fa-icon
        [icon]="icons.chevronRight"
        [class]="'text-muted text-xs transition-transform duration-150 ' + (menuOpen() ? 'rotate-90' : '')"
      ></fa-icon>
    }
  </button>

  <!-- Popout menu -->
  @if (menuOpen()) {
    <div class="fixed inset-0 z-40" (click)="closeMenu.emit()"></div>
    <div [class]="menuClasses()" role="menu">
      <div class="px-4 py-3 border-b border-subtle">
        <div class="text-sm font-medium text-primary">{{ user().name }}</div>
        <div class="text-xs text-muted">{{ user().email }}</div>
      </div>
      <div class="py-1">
        <button
          class="w-full px-4 py-2 text-sm text-secondary text-left hover:bg-surface-elevated hover:text-primary transition-colors flex items-center gap-3"
          role="menuitem"
        >
          <fa-icon [icon]="icons.user" class="w-4"></fa-icon>
          Profile
        </button>
        <button
          class="w-full px-4 py-2 text-sm text-secondary text-left hover:bg-surface-elevated hover:text-primary transition-colors flex items-center gap-3"
          role="menuitem"
        >
          <fa-icon [icon]="icons.lock" class="w-4"></fa-icon>
          Account settings
        </button>
        <button
          class="w-full px-4 py-2 text-sm text-secondary text-left hover:bg-surface-elevated hover:text-primary transition-colors flex items-center gap-3"
          role="menuitem"
        >
          <fa-icon [icon]="icons.bell" class="w-4"></fa-icon>
          Notifications
        </button>
        <button
          class="w-full px-4 py-2 text-sm text-secondary text-left hover:bg-surface-elevated hover:text-primary transition-colors flex items-center gap-3"
          role="menuitem"
        >
          <fa-icon [icon]="icons.questionCircle" class="w-4"></fa-icon>
          Help & support
        </button>
      </div>
      <div class="py-1 border-t border-subtle">
        <button
          (click)="logoutClick.emit()"
          class="w-full px-4 py-2 text-sm text-danger text-left hover:bg-danger/10 transition-colors flex items-center gap-3"
          role="menuitem"
        >
          <fa-icon [icon]="icons.signOutAlt" class="w-4"></fa-icon>
          Sign out
        </button>
      </div>
    </div>
  }
</div>
