<div cdkDrag class="flex flex-col w-72 shrink-0 max-h-[calc(100vh-12rem)]">
  <!-- Column drag placeholder -->
  <div *cdkDragPlaceholder class="w-72 h-full min-h-[200px] bg-accent/15 border-2 border-dashed border-accent/40 rounded-lg"></div>

  <!-- Column header (drag handle) -->
  <div cdkDragHandle class="flex items-center gap-2.5 mb-4 px-0.5 group relative">
    <div [class]="'w-2 h-2 rounded-full ' + accentClass()"></div>

    @if (editingName()) {
      <!-- Inline edit mode -->
      <input
        type="text"
        [(ngModel)]="editingValue"
        (keyup.enter)="saveName()"
        (keyup.escape)="cancelEdit()"
        (blur)="saveName()"
        class="flex-1 px-2 py-1 text-sm bg-surface text-primary border border-accent rounded focus:outline-none"
        autofocus
      />
    } @else {
      <h2 class="text-sm font-medium text-primary uppercase">{{ column().name }}</h2>
    }

    <span class="text-sm text-muted tabular-nums">{{ cards().length }}</span>

    <div class="ml-auto opacity-0 group-hover:opacity-100 transition-opacity">
      <button
        (click)="toggleMenu()"
        class="p-1 hover:bg-surface rounded transition-colors"
      >
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="text-muted">
          <circle cx="9" cy="5" r="1.5"/>
          <circle cx="9" cy="12" r="1.5"/>
          <circle cx="9" cy="19" r="1.5"/>
          <circle cx="15" cy="5" r="1.5"/>
          <circle cx="15" cy="12" r="1.5"/>
          <circle cx="15" cy="19" r="1.5"/>
        </svg>
      </button>
    </div>

    <!-- Column menu dropdown -->
    @if (menuOpen()) {
      <div class="absolute right-0 top-8 bg-surface border border-subtle rounded-lg shadow-lg py-1 z-10 min-w-[140px]">
        <button
          (click)="startEdit()"
          class="w-full px-3 py-2 text-left text-sm text-primary hover:bg-surface-elevated transition-colors"
        >
          Rename
        </button>
        <button
          (click)="deleteColumn()"
          class="w-full px-3 py-2 text-left text-sm text-red-400 hover:bg-red-500/10 transition-colors"
        >
          Delete
        </button>
      </div>
    }
  </div>

  <!-- Cards container (drop zone) -->
  <div
    cdkDropList
    [id]="column().id"
    [cdkDropListData]="cards()"
    [cdkDropListConnectedTo]="columnIds()"
    (cdkDropListDropped)="onCardDrop($event)"
    class="flex flex-col gap-2 rounded-lg transition-colors overflow-y-auto flex-1 min-h-24"
  >
    @for (card of cards(); track card.id) {
      <div cdkDrag [cdkDragData]="card" (cdkDragStarted)="onCardDragStarted($event)">
        <app-card [card]="card" (cardClick)="selectCard(card)"></app-card>
        <div *cdkDragPlaceholder class="card-drag-placeholder" [style.height.px]="draggedCardHeight()"></div>
      </div>
    }

    <!-- Inline add card form -->
    @if (addingCard()) {
      <div class="relative z-20 bg-surface border border-subtle rounded-lg p-3">
        <textarea
          [id]="'add-card-' + column().id"
          [(ngModel)]="newCardTitle"
          (keydown.enter)="$event.preventDefault(); saveCard()"
          (keyup.escape)="cancelAddCard()"
          (input)="autoResize($event)"
          placeholder="Card title..."
          rows="1"
          class="w-full px-0 py-0 text-sm bg-transparent text-primary placeholder:text-muted border-none focus:outline-none mb-2 resize-none overflow-hidden"
          autofocus
        ></textarea>
        <div class="flex gap-1.5">
          <button
            (click)="saveCard()"
            [disabled]="!newCardTitle().trim()"
            class="p-1 bg-cyan-500 text-white rounded hover:bg-cyan-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            title="Add card"
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </button>
          <button
            (click)="cancelAddCard()"
            class="p-1 bg-red-500/10 text-red-400 rounded hover:bg-red-500/20 transition-colors"
            title="Cancel"
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
    }
  </div>

  <!-- Add card button -->
  <button
    (click)="openAddCard()"
    class="mt-2 py-2 w-full text-sm text-muted rounded-lg hover:bg-surface hover:text-secondary transition-colors duration-150 shrink-0"
  >
    + Add card
  </button>
</div>
